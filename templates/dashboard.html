
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTrainer æ§åˆ¶å°</title>
    <!-- ä½¿ç”¨ jsDelivr åŠ è½½ä¾èµ– -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.3.4/dist/axios.min.js"></script>
    <style>
        [v-cloak] { display: none; } /* é˜²æ­¢ Vue åŠ è½½å‰æ˜¾ç¤ºèŠ±æ‹¬å· */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 8px; }
        .status-badge { min-width: 80px; display: inline-block; text-align: center; }
        
        /* çŠ¶æ€é…è‰² */
        .status-running { background-color: #e3f2fd; color: #0d6efd; border: 1px solid #0d6efd; }
        .status-pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-completed { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .status-failed { background-color: #f8d7da; color: #842029; border: 1px solid #f5c6cb; }
        .status-stopped { background-color: #e2e3e5; color: #41464b; border: 1px solid #d3d6d8; }
        /* [æ–°å¢] æš‚åœçŠ¶æ€æ ·å¼ */
        .status-paused { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; border-style: dashed; }

        /* [å…³é”®ä¿®å¤] è‡ªå®šä¹‰ Modal æ ·å¼ï¼Œä¸ä¾èµ– Bootstrap JS */
        .custom-modal-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* é˜²æ­¢é•¿å¼¹çª—æ— æ³•æ»šåŠ¨ */
            overflow-y: auto;
            padding-top: 50px;
            padding-bottom: 50px;
        }
        .custom-modal-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1051;
            margin: auto;
        }
        /* å¼ºåˆ¶è¿è¡Œçš„å°å¼¹çª— */
        .force-modal-content {
            max-width: 500px;
        }
        
        /* [æ–°å¢] æ—¥å¿—æŸ¥çœ‹å¼¹çª—ç‰¹åˆ«æ ·å¼ */
        .log-modal-content {
            max-width: 90%;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .log-viewer {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            white-space: pre-wrap;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            font-size: 0.9rem;
        }

        .btn-group-xs > .btn, .btn-xs {
            padding: .25rem .4rem;
            font-size: .875rem;
            line-height: 1.5;
            border-radius: .2rem;
        }
        .gpu-checkbox-label {
            cursor: pointer;
            display: block;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .gpu-checkbox-label:hover { background-color: #f8f9fa; }
        .gpu-checkbox-label.selected { background-color: #e3f2fd; border-color: #0d6efd; color: #0d6efd; font-weight: bold; }
    </style>
</head>
<body>
    <!-- v-cloak ç¡®ä¿ Vue åŠ è½½å®Œæˆå‰ä¸æ˜¾ç¤ºä¹±ç  -->
    <div id="app" class="container-fluid py-4 px-4" v-cloak>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-primary"><span style="color:#333">Auto</span>Trainer <small class="text-muted fs-6">Pro Edition</small></h2>
            <button class="btn btn-primary btn-lg shadow-sm" @click="openModal(null)">
                <span style="font-size: 1.1rem; font-weight: bold;">+ æ–°å»ºè®­ç»ƒä»»åŠ¡</span>
            </button>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="row g-3 mb-4">
            <div class="col-md-2">
                <div class="card p-3 text-center">
                    <div class="text-muted small">æ’é˜Ÿä¸­ (Pending)</div>
                    <div class="fs-2 fw-bold text-warning">{{ stats.pending }}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card p-3 text-center">
                    <div class="text-muted small">è¿è¡Œä¸­ (Running)</div>
                    <div class="fs-2 fw-bold text-primary">{{ stats.running }}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card p-3 text-center">
                    <div class="text-muted small">è¿‘30æ—¥å®Œæˆ</div>
                    <div class="fs-2 fw-bold text-success">{{ stats.success_30d }}</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card p-3 text-center">
                    <div class="text-muted small">è¿‘30æ—¥å¤±è´¥</div>
                    <div class="fs-2 fw-bold text-danger">{{ stats.failed_30d }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3" style="height: 100%;">
                    <div class="text-muted small mb-2">GPU å®æ—¶ç›‘æ§ (é˜ˆå€¼: 2000MB)</div>
                    <div class="row g-2" style="max-height: 160px; overflow-y: auto;">
                        <div class="col-6" v-for="gpu in gpus" :key="gpu.id">
                            <div class="border rounded p-1 small d-flex justify-content-between align-items-center" 
                                 :class="gpu.is_free ? 'bg-light text-success' : 'bg-light text-danger'">
                                <span>GPU {{gpu.id}}</span>
                                <span>{{gpu.mem_used}}M / {{gpu.util}}%</span>
                            </div>
                        </div>
                        <div v-if="gpus.length === 0" class="text-muted small text-center w-100 mt-2">
                            æœªæ£€æµ‹åˆ° GPU æˆ– é©±åŠ¨æœªå®‰è£…
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">ä»»åŠ¡é˜Ÿåˆ—</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">ID</th>
                                    <th width="20%">ä»»åŠ¡åç§°/å‘½ä»¤</th>
                                    <th width="10%">çŠ¶æ€</th>
                                    <th width="10%">é…ç½®</th>
                                    <th width="15%">æ—¶é—´</th>
                                    <th width="20%">è¯¦æƒ…</th>
                                    <th width="20%">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="task in tasks" :key="task.id" :class="{'table-active': task.status === 'running'}">
                                    <td>#{{ task.id }}</td>
                                    <td>
                                        <div class="fw-bold">{{ task.name }}</div>
                                        <div class="text-muted small text-truncate" style="max-width: 250px;" :title="task.command">{{ task.command }}</div>
                                    </td>
                                    <td>
                                        <span class="badge rounded-pill status-badge" :class="'status-' + task.status">
                                            {{ task.status }}
                                        </span>
                                        <div v-if="task.status === 'running'" class="small text-primary mt-1">PID: {{ task.pid }}</div>
                                    </td>
                                    <td>
                                        <div class="small">GPU: {{ task.gpu_config.min_gpus }}~{{ task.gpu_config.max_gpus }}</div>
                                        <div v-if="task.retry_count > 0" class="small text-danger">Retry: {{task.retry_count}}</div>
                                    </td>
                                    <td class="small">
                                        <div v-if="task.started_at">å§‹: {{ formatTime(task.started_at) }}</div>
                                        <div v-if="task.finished_at">ç»ˆ: {{ formatTime(task.finished_at) }}</div>
                                        <div v-if="!task.started_at" class="text-muted">ç­‰å¾…ä¸­...</div>
                                    </td>
                                    <td>
                                        <div v-if="task.artifact_dir" class="small text-success mb-1" title="äº§ç‰©æŠ“å–å¼€å¯">
                                            ğŸ“¸ äº§ç‰©: {{ task.artifact_pattern || '*' }}
                                        </div>
                                        <div v-if="task.file_swaps && task.file_swaps.length > 0" class="small text-muted">
                                            ğŸ“„ {{ task.file_swaps.length }} ä¸ªæ–‡ä»¶æ›¿æ¢
                                        </div>
                                        <div v-if="task.status==='failed' || task.status==='completed' || task.status==='stopped'" class="small">
                                            Exit: {{ task.exit_code }}
                                            <span v-if="task.log_file_path" class="ms-1" title="æ—¥å¿—å·²ä¿å­˜">ğŸ“</span>
                                        </div>
                                        <div v-if="task.error_msg" class="text-danger small text-truncate" style="max-width: 200px;" :title="task.error_msg">
                                            {{ task.error_msg }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-wrap gap-1">
                                            <!-- [æ–°å¢] å¼ºåˆ¶ç«‹å³è¿è¡ŒæŒ‰é’® -->
                                            <button v-if="task.status !== 'running'" class="btn btn-sm btn-danger" @click="openForceModal(task)" title="å¿½ç•¥é˜Ÿåˆ—å¼ºåˆ¶ç«‹å³æ‰§è¡Œ">
                                                ğŸš€ ç«‹åˆ»å¼ºè¡Œè¿è¡Œ
                                            </button>

                                            <!-- åœæ­¢æŒ‰é’® -->
                                            <button v-if="task.status === 'running' || task.status === 'pending'" 
                                                    class="btn btn-sm btn-outline-warning" @click="stopTask(task.id)">â¹ åœæ­¢</button>

                                            <!-- æ—¥å¿— -->
                                            <button v-if="task.log_file_path || task.status === 'running'" class="btn btn-sm btn-outline-dark" @click="viewLog(task.id)" title="æŸ¥çœ‹æ—¥å¿—">
                                                ğŸ“œ æ—¥å¿—
                                            </button>

                                            <!-- å¼€å§‹æŒ‰é’® (ä»… Paused) -->
                                            <button v-if="task.status === 'paused'" class="btn btn-sm btn-success" @click="startTask(task.id)">
                                                â–¶ å¼€å§‹
                                            </button>
                                            
                                            <!-- ç¼–è¾‘æŒ‰é’® -->
                                            <button v-if="task.status !== 'running'" class="btn btn-sm btn-outline-primary" @click="openModal(task)">
                                                âœ ç¼–è¾‘
                                            </button>

                                            <!-- å¤åˆ¶æŒ‰é’® (æ‰€æœ‰) -->
                                            <button class="btn btn-sm btn-outline-secondary" @click="copyTask(task.id)">
                                                ğŸ“‹ å¤åˆ¶
                                            </button>

                                            <!-- é‡è¯•æŒ‰é’® (Failed/Completed/Stopped) -->
                                            <button v-if="['failed', 'completed', 'stopped'].includes(task.status)" 
                                                    class="btn btn-sm btn-outline-info" @click="retryTask(task.id)">
                                                ğŸ”„ é‡è¯•
                                            </button>

                                            <!-- åˆ é™¤æŒ‰é’® -->
                                            <button class="btn btn-sm btn-outline-danger" @click="delTask(task.id)">ğŸ—‘</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="tasks.length === 0">
                                    <td colspan="7" class="text-center py-5 text-muted">
                                        <h4>ğŸ“­</h4>
                                        <div>å½“å‰æ— ä»»åŠ¡ï¼Œç‚¹å‡»å³ä¸Šè§’æ–°å»º</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å»º/ç¼–è¾‘ä»»åŠ¡å¼¹çª— -->
        <div class="custom-modal-backdrop" v-if="showModal" @click.self="showModal = false">
            <div class="custom-modal-content">
                <div class="modal-header p-3 border-bottom d-flex justify-content-between">
                    <h5 class="modal-title mb-0">{{ editingId ? 'ç¼–è¾‘ä»»åŠ¡' : 'åˆ›å»ºæ–°è®­ç»ƒä»»åŠ¡' }}</h5>
                    <button type="button" class="btn-close" @click="showModal = false"></button>
                </div>
                <div class="modal-body p-4">
                    <form @submit.prevent="submitTask">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">ä»»åŠ¡åç§° <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" v-model="form.name" required placeholder="ä¾‹å¦‚: Baseline_V1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">å·¥ä½œç›®å½• (Git Root) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" v-model="form.working_dir" required placeholder="/path/to/project">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">å¯åŠ¨å‘½ä»¤ <span class="text-danger">*</span></label>
                            <div class="text-muted small mb-1">æç¤ºï¼šæ”¯æŒ "conda activate env && python script.py" (Linux)</div>
                            <textarea class="form-control font-monospace bg-light" v-model="form.command" rows="3" required placeholder="conda activate MyEnv && python train.py"></textarea>
                        </div>

                        <!-- äº§ç‰©æŠ“å–é…ç½® -->
                        <div class="mb-3 p-3 bg-light border rounded">
                            <label class="form-label fw-bold text-success">ğŸ“¸ ç»“æœäº§ç‰©è‡ªåŠ¨å‘é€ (Artifacts)</label>
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" v-model="form.artifact_dir" placeholder="è¾“å‡ºæ–‡ä»¶ç›®å½• (ç»å¯¹è·¯å¾„, ç•™ç©ºåˆ™ä¸æŠ“å–)">
                                    <div class="form-text">äº§ç‰©ç›®å½•</div>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" v-model="form.artifact_pattern" placeholder="æ–‡ä»¶åæ¨¡å¼ (é»˜è®¤ *.jpg)">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3 border rounded mx-1 p-2">
                            <div class="col-md-4">
                                <label class="form-label">æœ€å°æ˜¾å¡æ•°</label>
                                <input type="number" class="form-control" v-model="form.min_gpus" min="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">æœ€å¤§æ˜¾å¡æ•°</label>
                                <input type="number" class="form-control" v-model="form.max_gpus" min="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">å¤±è´¥é‡è¯•æ¬¡æ•°</label>
                                <input type="number" class="form-control" v-model="form.retry_count" min="0" value="1">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label d-flex justify-content-between align-items-center">
                                <span class="fw-bold">ğŸ§© æ¨¡å—æ–‡ä»¶æ›¿æ¢ (å¯é€‰)</span>
                                <button type="button" class="btn btn-sm btn-outline-primary" @click="addSwap">+ æ·»åŠ æ›¿æ¢å¯¹</button>
                            </label>
                            <div v-for="(swap, idx) in form.swaps" :key="idx" class="input-group mb-2">
                                <span class="input-group-text bg-white">æº</span>
                                <input type="text" class="form-control" v-model="swap.source" placeholder="Source Path">
                                <span class="input-group-text bg-white">â” ç›®æ ‡</span>
                                <input type="text" class="form-control" v-model="swap.target" placeholder="Target Path">
                                <button type="button" class="btn btn-outline-danger" @click="form.swaps.splice(idx, 1)">Ã—</button>
                            </div>
                            <div v-if="form.swaps.length === 0" class="text-muted small">æ— æ–‡ä»¶æ›¿æ¢æ“ä½œ (é€šå¸¸ç”¨äºä¸´æ—¶ä¿®æ”¹ä»£ç æ–‡ä»¶)</div>
                        </div>

                        <div class="modal-footer px-0 pb-0 pt-3 border-top">
                            <button type="button" class="btn btn-secondary me-2" @click="showModal = false">å–æ¶ˆ</button>
                            <button type="submit" class="btn btn-primary px-4">{{ editingId ? 'ä¿å­˜æ›´æ”¹' : 'æäº¤ä»»åŠ¡' }}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- [æ–°å¢] å¼ºåˆ¶è¿è¡Œé…ç½®å¼¹çª— -->
        <div class="custom-modal-backdrop" v-if="showForceModal" @click.self="showForceModal = false">
            <div class="custom-modal-content force-modal-content">
                <div class="modal-header p-3 border-bottom d-flex justify-content-between bg-danger text-white">
                    <h5 class="modal-title mb-0">ğŸš€ å¼ºåˆ¶ç«‹å³è¿è¡Œ</h5>
                    <button type="button" class="btn-close btn-close-white" @click="showForceModal = false"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-warning small">
                        <strong>âš ï¸ è­¦å‘Šï¼š</strong> æ­¤æ“ä½œå°†å¿½ç•¥é˜Ÿåˆ—é¡ºåºå’Œæ˜¾å¡å ç”¨æƒ…å†µï¼Œç«‹å³å°è¯•å¯åŠ¨ã€‚<br>
                        å¦‚æœå¤±è´¥ï¼Œä»»åŠ¡å°†å›æ»šåˆ°åŸçŠ¶æ€ã€‚<br>
                        è¯·æ‰‹åŠ¨æŒ‡å®šè¦ä½¿ç”¨çš„æ˜¾å¡ï¼ˆå¤šé€‰ï¼‰ã€‚
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">é€‰æ‹©æ˜¾å¡ (å½“å‰çŠ¶æ€)</label>
                        <div class="d-flex flex-wrap gap-2">
                            <label v-for="gpu in gpus" :key="gpu.id" class="gpu-checkbox-label" :class="{'selected': forceForm.selected_gpus.includes(gpu.id)}">
                                <input type="checkbox" :value="gpu.id" v-model="forceForm.selected_gpus" class="d-none">
                                <div>GPU {{ gpu.id }}</div>
                                <div class="small" :class="gpu.is_free ? 'text-success' : 'text-danger'">
                                    {{ gpu.mem_used }}MB ({{ gpu.util }}%)
                                </div>
                            </label>
                        </div>
                        <div v-if="forceForm.selected_gpus.length === 0" class="text-danger small mt-2">
                            è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ æ˜¾å¡ã€‚
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-secondary me-2" @click="showForceModal = false">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-danger px-4" 
                                :disabled="forceForm.selected_gpus.length === 0"
                                @click="submitForceRun">
                            ç¡®è®¤ç«‹å³æ‰§è¡Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—æŸ¥çœ‹å¼¹çª— -->
        <div class="custom-modal-backdrop" v-if="showLogModal" @click.self="showLogModal = false">
            <div class="custom-modal-content log-modal-content">
                <div class="modal-header p-3 border-bottom d-flex justify-content-between">
                    <h5 class="modal-title mb-0">ğŸ“œ è¿è¡Œæ—¥å¿— (Tail) - Task #{{ currentLogTaskId }}</h5>
                    <button type="button" class="btn-close" @click="showLogModal = false"></button>
                </div>
                <div class="log-viewer" ref="logContainer">
                    <div v-if="logLoading" class="text-center text-muted">åŠ è½½ä¸­...</div>
                    <div v-else-if="logContent">{{ logContent }}</div>
                    <div v-else class="text-center text-muted">æš‚æ— æ—¥å¿—å†…å®¹</div>
                </div>
                <div class="modal-footer p-2 bg-light border-top">
                    <button class="btn btn-sm btn-secondary" @click="fetchLog(currentLogTaskId)">åˆ·æ–°</button>
                    <button class="btn btn-sm btn-primary" @click="showLogModal = false">å…³é—­</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                stats: { pending: 0, running: 0, success_30d: 0, failed_30d: 0 },
                tasks: [],
                gpus: [],
                gpu_threshold: 0,
                showModal: false,
                showLogModal: false,
                showForceModal: false, // [æ–°å¢]
                forceForm: {
                    task_id: null,
                    selected_gpus: []
                },
                logContent: '',
                logLoading: false,
                currentLogTaskId: null,
                editingId: null, 
                form: {
                    name: '',
                    command: '',
                    working_dir: '',
                    min_gpus: 1,
                    max_gpus: 8,
                    retry_count: 1,
                    artifact_dir: '',
                    artifact_pattern: '',
                    swaps: []
                }
            },
            methods: {
                loadData() {
                    axios.get('/api/stats').then(res => {
                        this.stats = res.data.stats;
                        this.gpus = res.data.gpus;
                        this.tasks = res.data.tasks;
                    }).catch(console.error);
                },
                openModal(task) {
                    if (task) {
                        // ç¼–è¾‘æ¨¡å¼
                        if (['completed', 'failed', 'stopped'].includes(task.status)) {
                            if (!confirm("ç¼–è¾‘å·²å®Œæˆæˆ–åœæ­¢çš„ä»»åŠ¡å°†é‡æ–°åŠ å…¥é˜Ÿåˆ—å¹¶é‡ç½®çŠ¶æ€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
                                return;
                            }
                        }
                        this.editingId = task.id;
                        this.form = {
                            name: task.name,
                            command: task.command,
                            working_dir: task.working_dir,
                            min_gpus: task.gpu_config.min_gpus,
                            max_gpus: task.gpu_config.max_gpus,
                            retry_count: task.max_retries,
                            artifact_dir: task.artifact_dir || '',
                            artifact_pattern: task.artifact_pattern || '',
                            swaps: JSON.parse(JSON.stringify(task.file_swaps || []))
                        };
                    } else {
                        // æ–°å»ºæ¨¡å¼
                        this.editingId = null;
                        this.form = {
                            name: '',
                            command: '',
                            working_dir: this.form.working_dir || '.', 
                            min_gpus: 1,
                            max_gpus: 8,
                            retry_count: 1,
                            artifact_dir: '',
                            artifact_pattern: '',
                            swaps: []
                        };
                    }
                    this.showModal = true;
                },
                // [æ–°å¢] æ‰“å¼€å¼ºåˆ¶è¿è¡Œ Modal
                openForceModal(task) {
                    this.forceForm.task_id = task.id;
                    this.forceForm.selected_gpus = [];
                    // é»˜è®¤é€‰ä¸€å¼ æœ€ç©ºé—²çš„
                    const freeGpu = this.gpus.find(g => g.is_free);
                    if (freeGpu) {
                        this.forceForm.selected_gpus.push(freeGpu.id);
                    }
                    this.showForceModal = true;
                },
                // [æ–°å¢] æäº¤å¼ºåˆ¶è¿è¡Œ
                submitForceRun() {
                    if (!confirm("âš ï¸ å†æ¬¡ç¡®è®¤ï¼š\næ‚¨ç¡®å®šè¦å¿½ç•¥é˜Ÿåˆ—ç«‹å³æ‰§è¡Œæ­¤ä»»åŠ¡å—ï¼Ÿ\nå¦‚æœå¤±è´¥ï¼Œä»»åŠ¡å°†å›æ»šåˆ°åŸçŠ¶æ€ã€‚")) return;
                    
                    axios.post(`/api/tasks/${this.forceForm.task_id}/force_run`, {
                        gpu_ids: this.forceForm.selected_gpus
                    }).then(res => {
                        this.showForceModal = false;
                        this.loadData();
                        alert('å·²å‘é€ç«‹å³æ‰§è¡ŒæŒ‡ä»¤ï¼');
                    }).catch(err => alert('æ“ä½œå¤±è´¥: ' + (err.response?.data?.msg || err.message)));
                },
                viewLog(taskId) {
                    this.currentLogTaskId = taskId;
                    this.showLogModal = true;
                    this.logContent = '';
                    this.fetchLog(taskId);
                },
                // [æ–°å¢] è·å–æ—¥å¿—å†…å®¹
                fetchLog(taskId) {
                    this.logLoading = true;
                    axios.get(`/api/tasks/${taskId}/log`).then(res => {
                        this.logContent = res.data.content;
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                        this.$nextTick(_ => {
                            if(this.$refs.logContainer) {
                                this.$refs.logContainer.scrollTop = this.$refs.logContainer.scrollHeight;
                            }
                        });
                    }).catch(err => {
                        this.logContent = "æ— æ³•è·å–æ—¥å¿—æˆ–æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ã€‚\n" + (err.response?.data?.msg || err.message);
                    }).finally(_ => {
                        this.logLoading = false;
                    });
                },
                addSwap() {
                    this.form.swaps.push({source: '', target: ''});
                },
                submitTask() {
                    const fd = new FormData();
                    fd.append('name', this.form.name);
                    fd.append('command', this.form.command);
                    fd.append('working_dir', this.form.working_dir);
                    fd.append('min_gpus', this.form.min_gpus);
                    fd.append('max_gpus', this.form.max_gpus);
                    fd.append('retry_count', this.form.retry_count);
                    fd.append('artifact_dir', this.form.artifact_dir);
                    fd.append('artifact_pattern', this.form.artifact_pattern);
                    
                    const validSwaps = this.form.swaps.filter(s => s.source && s.target);
                    fd.append('swaps_json', JSON.stringify(validSwaps));

                    let url = '/api/tasks/create';
                    if (this.editingId) {
                        url = `/api/tasks/${this.editingId}/update`;
                    }

                    axios.post(url, fd).then(res => {
                        this.showModal = false;
                        this.loadData();
                        alert(this.editingId ? 'ä»»åŠ¡å·²æ›´æ–°ï¼' : 'ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—ï¼');
                    }).catch(err => alert('æ“ä½œå¤±è´¥: ' + (err.response?.data?.msg || err.message)));
                },
                stopTask(id) {
                    if(!confirm('ç¡®å®šè¦åœæ­¢è¯¥ä»»åŠ¡å—ï¼Ÿ')) return;
                    axios.post(`/api/tasks/${id}/stop`).then(this.loadData);
                },
                delTask(id) {
                    if(!confirm('ç¡®å®šè¦åˆ é™¤è®°å½•å—ï¼Ÿ')) return;
                    axios.delete(`/api/tasks/${id}`).then(this.loadData);
                },
                copyTask(id) {
                    axios.post(`/api/tasks/${id}/copy`).then(_ => {
                        this.loadData();
                        alert('ä»»åŠ¡å·²å¤åˆ¶å¹¶æš‚åœï¼Œè¯·ç‚¹å‡»å¼€å§‹ä»¥åŠ å…¥é˜Ÿåˆ—ã€‚');
                    });
                },
                retryTask(id) {
                    axios.post(`/api/tasks/${id}/retry`).then(_ => {
                        this.loadData();
                        alert('ä»»åŠ¡å·²é‡æ–°åŠ å…¥é˜Ÿåˆ—ã€‚');
                    });
                },
                startTask(id) {
                    axios.post(`/api/tasks/${id}/start`).then(_ => {
                        this.loadData();
                    });
                },
                formatTime(t) {
                    if(!t) return '-';
                    return new Date(t).toLocaleString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
                }
            },
            mounted() {
                console.log("AutoTrainer Frontend Mounted.");
                this.loadData();
                setInterval(this.loadData, 3000); 
            }
        });
    </script>
</body>
</html>
